---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { ProfileRepository } from '../../infrastructure/ProfileRepository';

// Note: This page is protected by Azure Static Web Apps route protection (staticwebapp.config.json)
// It will only be served to authenticated users
// The x-ms-client-principal header will be available at runtime on Azure

// For local dev and static builds, use placeholder data
const userProfile = {
	userId: 'placeholder-user-id',
	displayName: 'Your Name',
	bio: '',
	skills: [],
	interests: [],
	location: '',
	timezone: '',
	availability: 'active',
};

const user = {
	userId: 'placeholder-user-id',
	githubUsername: 'username',
	avatarUrl: '',
};

// Check if we're in edit mode
const isEditMode = Astro.url.searchParams.get('edit') === 'true';
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{isEditMode ? 'Edit Profile' : 'My Profile'} - CodePals</title>
	</head>
	<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
		<Header />

		<main class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 py-12">
			<div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
				<div class="flex items-start justify-between gap-6">
					<div class="flex items-start gap-6">
						<img
							src={user?.avatarUrl}
							alt={user?.githubUsername}
							class="w-24 h-24 rounded-full border-4 border-primary-100"
						/>
						<div class="flex-1">
							<h1 class="text-3xl font-bold text-slate-900 mb-2">
								@{user?.githubUsername}
							</h1>
							<p class="text-slate-600 mb-4">
								CodePals Member
							</p>
						</div>
					</div>
					
					{!isEditMode ? (
						<button
							onclick="window.location.href='/profile?edit=true'"
							class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors flex items-center gap-2"
						>
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
							</svg>
							Edit Profile
						</button>
					) : (
						<button
							onclick="window.location.href='/profile'"
							class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors"
						>
							Cancel
						</button>
					)}
				</div>
			</div>

			{!isEditMode ? (
				<>
				{(!userProfile.bio || userProfile.skills.length < 2 || userProfile.interests.length < 2) && (
					<div class="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-8">
						<div class="flex items-start gap-4">
							<svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
							</svg>
							<div>
								<h3 class="font-semibold text-amber-900 mb-1">Complete your profile</h3>
								<p class="text-amber-800 text-sm mb-3">
									Add your bio, skills, and interests to help other CodePals find and connect with you.
								</p>
								<button 
									onclick="window.location.href='/profile?edit=true'"
									class="text-sm font-medium text-amber-700 hover:text-amber-800 underline"
								>
									Complete your profile â†’
								</button>
							</div>
						</div>
					</div>
				)}

				<div class="space-y-6">
					<div class="bg-white rounded-xl shadow p-6">
						<h2 class="text-xl font-bold text-slate-900 mb-4">About Me</h2>
						{userProfile?.bio ? (
							<p class="text-slate-700 whitespace-pre-wrap">{userProfile.bio}</p>
						) : (
							<p class="text-slate-600 italic">
								No bio added yet. Click "Edit Profile" to add one.
							</p>
						)}
					</div>

					<div class="bg-white rounded-xl shadow p-6">
						<h2 class="text-xl font-bold text-slate-900 mb-4">Skills</h2>
						{userProfile?.skills?.length > 0 ? (
							<div class="flex flex-wrap gap-2">
								{userProfile.skills.map((skill: string) => (
									<span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm">
										{skill}
									</span>
								))}
							</div>
						) : (
							<p class="text-slate-600 italic">
								No skills added yet. Click "Edit Profile" to add some.
							</p>
						)}
					</div>

					<div class="bg-white rounded-xl shadow p-6">
						<h2 class="text-xl font-bold text-slate-900 mb-4">Interests</h2>
						{userProfile?.interests?.length > 0 ? (
							<div class="flex flex-wrap gap-2">
								{userProfile.interests.map((interest: string) => (
									<span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">
										{interest}
									</span>
								))}
							</div>
						) : (
							<p class="text-slate-600 italic">
								No interests added yet. Click "Edit Profile" to add some.
							</p>
						)}
					</div>

					{(userProfile?.location || userProfile?.timezone || userProfile?.availability) && (
						<div class="bg-white rounded-xl shadow p-6">
							<h2 class="text-xl font-bold text-slate-900 mb-4">Details</h2>
							<div class="space-y-2">
								{userProfile.location && (
									<p class="text-slate-700">
										<span class="font-semibold">Location:</span> {userProfile.location}
									</p>
								)}
								{userProfile.timezone && (
									<p class="text-slate-700">
										<span class="font-semibold">Timezone:</span> {userProfile.timezone}
									</p>
								)}
								{userProfile.availability && (
									<p class="text-slate-700">
										<span class="font-semibold">Availability:</span> <span class="capitalize">{userProfile.availability.replace('_', ' ')}</span>
									</p>
								)}
							</div>
						</div>
					)}
				</div>
				</>
			) : (
				<div class="bg-white rounded-2xl shadow-lg p-8">
					<h2 class="text-2xl font-bold text-slate-900 mb-6">Edit Your Profile</h2>
					
				<form id="profile-form" class="space-y-6">
					<div>
							<label for="displayName" class="block text-sm font-semibold text-slate-900 mb-2">
								Display Name *
							</label>
							<input
								type="text"
								id="displayName"
								name="displayName"
								required
								value={userProfile?.displayName || user?.githubUsername || ''}
								placeholder="How should we call you?"
								class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
							/>
						</div>

						<div>
							<label for="bio" class="block text-sm font-semibold text-slate-900 mb-2">
								Bio *
							</label>
							<textarea
								id="bio"
								name="bio"
								required
								rows="4"
								maxlength="500"
								placeholder="Tell us about yourself, your interests, and what you're looking for in a CodePal..."
								class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
							>{userProfile?.bio || ''}</textarea>
							<p class="mt-1 text-sm text-slate-500">
								<span id="bio-count">0</span>/500 characters (minimum 50)
							</p>
						</div>

						<div>
							<label class="block text-sm font-semibold text-slate-900 mb-2">
								Skills * (at least 2)
							</label>
							<input
								type="text"
								id="skills-input"
								placeholder="Type a skill and press Enter to add (e.g., C#, JavaScript, Python)"
								class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
							/>
							<p class="mt-1 text-sm text-slate-500">
								ðŸ’¡ Type each skill and press <kbd class="px-2 py-0.5 bg-slate-200 rounded text-xs">Enter</kbd> or <kbd class="px-2 py-0.5 bg-slate-200 rounded text-xs">comma</kbd> to add it
							</p>
							<div id="skills-container" class="flex flex-wrap gap-2 mt-3 min-h-[40px]">
							</div>
						</div>

						<div>
							<label class="block text-sm font-semibold text-slate-900 mb-2">
								Interests * (at least 2)
							</label>
							<input
								type="text"
								id="interests-input"
								placeholder="Type an interest and press Enter to add (e.g., Web Development, AI)"
								class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
							/>
							<p class="mt-1 text-sm text-slate-500">
								ðŸ’¡ Type each interest and press <kbd class="px-2 py-0.5 bg-slate-200 rounded text-xs">Enter</kbd> or <kbd class="px-2 py-0.5 bg-slate-200 rounded text-xs">comma</kbd> to add it
							</p>
							<div id="interests-container" class="flex flex-wrap gap-2 mt-3 min-h-[40px]">
							</div>
					</div>

					<div class="grid md:grid-cols-2 gap-6">
							<div>
								<label for="location" class="block text-sm font-semibold text-slate-900 mb-2">
									Location
								</label>
								<input
									type="text"
									id="location"
									name="location"
									value={userProfile?.location || ''}
									placeholder="e.g., Dublin, Ireland"
									class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
								/>
							</div>

							<div>
								<label for="timezone" class="block text-sm font-semibold text-slate-900 mb-2">
									Timezone
								</label>
								<select
									id="timezone"
									name="timezone"
									class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
								>
									<option value="">Select timezone</option>
									<option value="UTC">UTC</option>
									<option value="Europe/Dublin">Europe/Dublin (GMT)</option>
									<option value="Europe/London">Europe/London (GMT)</option>
									<option value="America/New_York">America/New York (EST)</option>
									<option value="America/Los_Angeles">America/Los Angeles (PST)</option>
									<option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
									<option value="Australia/Sydney">Australia/Sydney (AEDT)</option>
								</select>
							</div>
						</div>

						<div>
							<label class="block text-sm font-semibold text-slate-900 mb-2">
								Availability
							</label>
							<div class="space-y-2">
								<label class="flex items-center gap-2">
									<input type="radio" name="availability" value="active" class="text-primary-500" checked />
									<span class="text-slate-700">Active - Looking for a CodePal</span>
								</label>
								<label class="flex items-center gap-2">
									<input type="radio" name="availability" value="casual" class="text-primary-500" />
									<span class="text-slate-700">Casual - Open to occasional connections</span>
								</label>
								<label class="flex items-center gap-2">
									<input type="radio" name="availability" value="unavailable" class="text-primary-500" />
									<span class="text-slate-700">Not available right now</span>
								</label>
							</div>
					</div>

					<div class="flex gap-4 pt-4">
							<button
								type="button"
								onclick="window.location.href='/profile'"
								class="px-6 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors"
							>
								Cancel
							</button>
							<button
								type="submit"
								id="submit-btn"
								class="px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors flex-1"
							>
								Save Profile
							</button>
						</div>
					</form>
				</div>
			)}
		</main>

		<Footer />

		{isEditMode && (
			<script is:inline define:vars={{ profile: userProfile }}>
				const skills = new Set(profile?.skills || []);
				const interests = new Set(profile?.interests || []);

				// Bio character count
				const bioTextarea = document.getElementById('bio');
				const bioCount = document.getElementById('bio-count');
				bioTextarea?.addEventListener('input', () => {
					if (bioCount) {
						bioCount.textContent = bioTextarea.value.length.toString();
					}
				});

				// Skills management
				const skillsInput = document.getElementById('skills-input');
				const skillsContainer = document.getElementById('skills-container');

				skillsInput?.addEventListener('keypress', (e) => {
					if (e.key === 'Enter' || e.key === ',') {
						e.preventDefault();
						const skill = skillsInput.value.replace(',', '').trim();
						if (skill && !skills.has(skill)) {
							skills.add(skill);
							addTag(skill, 'skill', skillsContainer);
							skillsInput.value = '';
						}
					}
				});

				// Interests management
				const interestsInput = document.getElementById('interests-input');
				const interestsContainer = document.getElementById('interests-container');

				interestsInput?.addEventListener('keypress', (e) => {
					if (e.key === 'Enter' || e.key === ',') {
						e.preventDefault();
						const interest = interestsInput.value.replace(',', '').trim();
						if (interest && !interests.has(interest)) {
							interests.add(interest);
							addTag(interest, 'interest', interestsContainer);
							interestsInput.value = '';
						}
					}
				});

				function addTag(text, type, container) {
					const tag = document.createElement('span');
					tag.className = 'inline-flex items-center gap-2 px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm';
					tag.innerHTML = `
						${text}
						<button type="button" class="hover:text-primary-900 text-lg leading-none" onclick="removeTag('${text}', '${type}')">Ã—</button>
					`;
					container.appendChild(tag);
				}

				window.removeTag = function(text, type) {
					if (type === 'skill') {
						skills.delete(text);
					} else {
						interests.delete(text);
					}
					renderTags();
				};

				function renderTags() {
					if (skillsContainer) {
						skillsContainer.innerHTML = '';
						skills.forEach(skill => addTag(skill, 'skill', skillsContainer));
					}
					if (interestsContainer) {
						interestsContainer.innerHTML = '';
						interests.forEach(interest => addTag(interest, 'interest', interestsContainer));
					}
				}

				// Form submission
				const form = document.getElementById('profile-form');
				form?.addEventListener('submit', async (e) => {
					e.preventDefault();

					const displayName = document.getElementById('displayName').value;
					const bio = document.getElementById('bio').value;
					const location = document.getElementById('location').value;
					const timezone = document.getElementById('timezone').value;
					const availability = document.querySelector('input[name="availability"]:checked')?.value;

					// Validation
					if (bio.length < 50) {
						alert('Bio must be at least 50 characters');
						return;
					}

					if (skills.size < 2) {
						alert('Please add at least 2 skills');
						return;
					}

					if (interests.size < 2) {
						alert('Please add at least 2 interests');
						return;
					}

					const profileData = {
						displayName,
						bio,
						skills: Array.from(skills),
						interests: Array.from(interests),
						location,
						timezone,
						availability: availability || 'active'
					};

					// Submit to API
					try {
						const response = await fetch('/api/profile/save', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify(profileData),
						});

						if (!response.ok) {
							const error = await response.json();
							throw new Error(error.error || 'Failed to save profile');
						}

						// Success - redirect to view mode
						window.location.href = '/profile';
					} catch (error) {
						console.error('Save error:', error);
						alert(error instanceof Error ? error.message : 'Failed to save profile');
					}
				});

				// Initialize existing skills/interests
				if (profile?.skills) {
					skills.forEach(skill => addTag(skill, 'skill', skillsContainer));
				}
				if (profile?.interests) {
					interests.forEach(interest => addTag(interest, 'interest', interestsContainer));
				}

				// Update bio character count on initialization
				if (bioTextarea && bioCount) {
					bioCount.textContent = bioTextarea.value.length.toString();
				}

				// Set timezone if it exists
				if (profile?.timezone) {
					const tzSelect = document.getElementById('timezone');
					if (tzSelect) {
						tzSelect.value = profile.timezone;
					}
				}

				// Set availability if it exists
				if (profile?.availability) {
					const availInput = document.querySelector(`input[name="availability"][value="${profile.availability}"]`);
					if (availInput) {
						availInput.checked = true;
					}
				}
			</script>
		)}
	</body>
</html>
